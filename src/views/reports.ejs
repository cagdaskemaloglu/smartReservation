<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= pageTitle %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    </head>
<body class="bg-dark text-white">
    
    <header class="bg-dark p-3 border-bottom border-secondary mb-4">
        <div class="container">
            <h1 class="text-primary display-5 mb-3">Admin Raporlama Paneli</h1>
            <nav>
                <a href="/" class="btn btn-sm btn-secondary">← Ana Sayfaya Dön</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="reports-main" class="row">
            <p>Raporlar yükleniyor...</p>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const token = localStorage.getItem('userToken');
        const reportsMain = document.getElementById('reports-main');

        async function authFetch(url, options = {}) {
            const token = localStorage.getItem('userToken');
            if (!token) { 
                window.location.href = '/login'; 
                return; 
            }

            const defaultOptions = {
                headers: { 
                    'Content-Type': 'application/json', 
                    'Authorization': `Bearer ${token}` 
                },
                ...options
            };
            return fetch(url, defaultOptions);
        }

        async function fetchAndRenderReports() {
            reportsMain.innerHTML = '<p class="text-warning mt-3">Raporlar çekiliyor...</p>';
            
            const reportUrls = [
                'resources/reports/top',
                'resources/reports/activity',
                'resources/reports/users'
            ];

            try {
                const responses = await Promise.all(reportUrls.map(url => authFetch(`${API_BASE_URL}/${url}`)));
                const reportsData = await Promise.all(responses.map(res => res.json()));

                reportsMain.innerHTML = '';

                //en çok kullanılan kaynaklar
                const topResources = reportsData[0];
                reportsMain.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="report-card card p-4 h-100">
                            <h2 class="text-primary">${topResources.reportName}</h2>
                            <ol class="list-group list-group-flush">
                                ${topResources.data.map(item => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${item._id.name} (${item._id.type})
                                        <span class="badge bg-primary rounded-pill">
                                            ${item.count} Rez.
                                        </span>
                                    </li>
                                `).join('')}
                            </ol>
                        </div>
                    </div>
                `;
                
                //günlük aktivite raporu
                const activityReport = reportsData[1];
                reportsMain.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="report-card card p-4 h-100">
                            <h2 class="text-primary">${activityReport.reportName}</h2>
                            <p class="fs-5">Bugün Yapılan Rezervasyon: 
                                <strong class="text-warning">${activityReport.daily}</strong>
                            </p>
                            <p class="fs-5">Son 7 Günlük Rezervasyon: 
                                <strong class="text-warning">${activityReport.weekly}</strong>
                            </p>
                        </div>
                    </div>
                `;

                //en aktif kullanıcılar raporu
                const topUsers = reportsData[2];
                reportsMain.innerHTML += `
                    <div class="col-md-6 mb-4">
                        <div class="report-card card p-4 h-100">
                            <h2 class="text-primary">${topUsers.reportName}</h2>
                            <ol class="list-group list-group-flush">
                                ${topUsers.data.map(item => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${item._id.name} (${item._id.email})
                                        <span class="badge bg-primary rounded-pill">
                                            ${item.count} Rez.
                                        </span>
                                    </li>
                                `).join('')}
                            </ol>
                        </div>
                    </div>
                `;

            } catch (error) {
                reportsMain.innerHTML = '<p class="alert alert-danger mt-3">Raporlar çekilirken yetkilendirme veya ağ hatası oluştu. Admin olarak giriş yaptığınızdan emin olun.</p>';
            }
        }

        if (token) {
            fetchAndRenderReports();
        } else {
            window.location.href = '/login';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eE+c67J5zV5d0c0u2wF7wHk" crossorigin="anonymous"></script>
</body>
</html>
